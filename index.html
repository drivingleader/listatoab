<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Patente Z - 2026 Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/canvas-confetti/1.6.0/confetti.browser.min.js"></script>
    <!-- Icone -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* --- CONFIGURAZIONE VISIVA --- */
        :root {
            --bg-body: #050505;
            --bg-card: #121214;
            --accent-purple: #8b5cf6;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --text-main: #ffffff;
            --text-dim: #a1a1aa;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100dvh; /* Altezza dinamica per mobile */
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        /* --- UTILITÃ€ --- */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* Effetto Vetro */
        .glass {
            background: rgba(30, 30, 35, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* --- ANIMAZIONI --- */
        @keyframes slideUp { 
            0% { transform: translateY(20px); opacity: 0; } 
            100% { transform: translateY(0); opacity: 1; } 
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .anim-enter { animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .anim-shake { animation: shake 0.3s ease-in-out; }

        /* --- BOTTONI GAMEPLAY --- */
        .btn-game {
            transition: all 0.1s;
            position: relative;
            overflow: hidden;
        }
        .btn-game:active {
            transform: scale(0.95);
            filter: brightness(1.2);
        }
        /* Overlay per effetto tocco */
        .btn-game::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: white;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .btn-game:active::after {
            opacity: 0.1;
        }

        /* --- SEGNALI STRADALI SVG --- */
        .sign-svg {
            width: 100px;
            height: 100px;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));
            margin: 0 auto;
        }
    </style>
</head>
<body class="flex flex-col w-full max-w-md mx-auto shadow-2xl bg-black">

    <!-- HEADER FISSO -->
    <header class="h-16 flex items-center justify-between px-5 bg-black/80 backdrop-blur-md border-b border-white/5 z-20">
        <div>
            <h1 class="text-xl font-black tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-500">
                PATENTE Z
            </h1>
            <p id="mode-badge" class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Training Mode</p>
        </div>
        <div class="flex items-center gap-2 px-3 py-1 bg-white/5 rounded-full border border-white/10">
            <span class="text-green-400 text-sm">ðŸ”¥</span>
            <span id="streak-counter" class="text-sm font-bold font-mono">0</span>
        </div>
    </header>

    <!-- AREA CENTRALE (SCORREVOLE/DINAMICA) -->
    <main class="flex-1 relative overflow-hidden flex flex-col">
        
        <!-- SCHERMATA GIOCO -->
        <div id="screen-game" class="absolute inset-0 flex flex-col px-4 pb-4 pt-2 z-10 transition-transform duration-300">
            
            <!-- Barra Progresso -->
            <div class="h-1 w-full bg-gray-800 rounded-full mb-4 overflow-hidden">
                <div id="progress-fill" class="h-full bg-purple-500 w-0 transition-all duration-300"></div>
            </div>

            <!-- Card Principale -->
            <div id="card-wrapper" class="flex-1 glass rounded-3xl p-5 flex flex-col items-center justify-center text-center relative overflow-hidden shadow-2xl">
                
                <!-- Feedback Visivo (Vero/Falso sovrapposto) -->
                <div id="feedback-layer" class="absolute inset-0 z-50 hidden flex-col items-center justify-center bg-black/90 transition-opacity duration-200">
                    <i id="fb-icon" class="text-6xl mb-4"></i>
                    <span id="fb-text" class="text-2xl font-black tracking-widest uppercase"></span>
                </div>

                <!-- Contenuto Card -->
                <div class="w-full h-full flex flex-col">
                    <!-- Parte Alta: Immagine + Radice -->
                    <div class="flex-none min-h-[100px] flex flex-col items-center justify-center border-b border-white/5 pb-4 mb-4">
                        <div id="sign-container" class="mb-3 hidden">
                            <!-- SVG iniettato qui -->
                        </div>
                        <p id="txt-root" class="text-gray-400 text-sm font-medium uppercase tracking-wide leading-snug">
                            Caricamento...
                        </p>
                    </div>

                    <!-- Parte Centrale: Completamento -->
                    <div class="flex-1 flex items-center justify-center">
                        <p id="txt-comp" class="text-2xl md:text-3xl font-bold text-white leading-tight">
                            --
                        </p>
                    </div>
                </div>
            </div>

            <!-- Controlli -->
            <div class="h-24 grid grid-cols-2 gap-4 mt-4">
                <button id="btn-false" class="btn-game rounded-2xl bg-[#1f1212] border border-red-500/30 text-red-500 flex flex-col items-center justify-center gap-1 shadow-lg shadow-red-900/10">
                    <i class="ph-bold ph-x text-3xl"></i>
                    <span class="font-bold tracking-wider">FALSO</span>
                </button>
                <button id="btn-true" class="btn-game rounded-2xl bg-[#0f1f15] border border-green-500/30 text-green-500 flex flex-col items-center justify-center gap-1 shadow-lg shadow-green-900/10">
                    <i class="ph-bold ph-check text-3xl"></i>
                    <span class="font-bold tracking-wider">VERO</span>
                </button>
            </div>
            
            <div id="topic-label" class="text-center mt-2 text-[10px] text-gray-600 font-mono truncate">
                ...
            </div>
        </div>

        <!-- SCHERMATA MENU (SELEZIONE) -->
        <div id="screen-menu" class="absolute inset-0 bg-black z-20 transform translate-y-full transition-transform duration-300 flex flex-col px-5 pt-6">
            <h2 class="text-2xl font-bold text-white mb-2">Scegli Argomento</h2>
            <p class="text-gray-500 text-sm mb-6">Seleziona cosa vuoi ripassare oggi.</p>
            
            <div id="list-container" class="flex-1 overflow-y-auto hide-scroll space-y-3 pb-24">
                <!-- Lista generata via JS -->
            </div>

            <div class="absolute bottom-0 left-0 w-full p-5 bg-gradient-to-t from-black via-black to-transparent">
                <button id="btn-start-custom" class="w-full py-4 bg-white text-black font-bold rounded-xl text-lg shadow-xl active:scale-95 transition-transform">
                    Inizia Sessione
                </button>
            </div>
        </div>

    </main>

    <!-- NAVIGAZIONE -->
    <nav class="h-20 bg-black border-t border-white/5 flex items-start justify-around pt-4 z-30 pb-safe">
        <button onclick="app.goMix()" class="nav-btn flex flex-col items-center gap-1 text-purple-500 w-16 opacity-100 transition-opacity">
            <i class="ph-fill ph-shuffle text-2xl"></i>
            <span class="text-[10px] font-bold">Mix</span>
        </button>
        <button onclick="app.toggleMenu()" class="nav-btn flex flex-col items-center gap-1 text-gray-500 w-16 opacity-70 transition-opacity">
            <i class="ph-fill ph-student text-2xl"></i>
            <span class="text-[10px] font-bold">Studio</span>
        </button>
    </nav>

    <!-- LOGICA APP -->
    <script>
        // --- 1. IL DATABASE (DATI PURI, NIENTE PARSING) ---
        // Ho inserito qui i dati del tuo file, puliti e strutturati.
        const DB = [
            {
                id: "L1", title: "Definizioni Stradali",
                items: [
                    { root: "La strada Ã¨...", text: "...aperta alla circolazione dei pedoni, degli animali e dei veicoli", isTrue: true, topic: "La Strada" },
                    { root: "La strada Ã¨...", text: "...riservata alla circolazione dei soli autoveicoli e motocicli", isTrue: false, topic: "La Strada" },
                    { root: "La strada puÃ²...", text: "...essere a senso unico di circolazione", isTrue: true, topic: "La Strada" },
                    { root: "La carreggiata Ã¨...", text: "...la parte della strada destinata normalmente alla circolazione dei veicoli", isTrue: true, topic: "Carreggiata" },
                    { root: "La carreggiata Ã¨...", text: "...destinata alla sosta degli autocarri", isTrue: false, topic: "Carreggiata" },
                    { root: "Fanno parte della carreggiata...", text: "...gli attraversamenti pedonali", isTrue: true, topic: "Carreggiata" },
                    { root: "La carreggiata non comprende...", text: "...i marciapiedi", isTrue: true, topic: "Carreggiata" },
                    { root: "La corsia puÃ²...", text: "...essere destinata ad effettuare sorpassi", isTrue: true, topic: "Corsia" },
                    { root: "La corsia puÃ²...", text: "...essere a doppio senso di circolazione", isTrue: false, topic: "Corsia" },
                    { root: "L'intersezione a raso...", text: "...Ã¨ un'intersezione di due o piÃ¹ strade poste allo stesso livello", isTrue: true, topic: "Incroci" },
                    { root: "Il marciapiede Ã¨...", text: "...riservato ai pedoni", isTrue: true, topic: "Marciapiedi" }
                ]
            },
            {
                id: "L2", title: "Doveri del Conducente",
                items: [
                    { root: "Ãˆ vietato...", text: "...spostare o imbrattare la segnaletica stradale", isTrue: true, topic: "Divieti" },
                    { root: "Ãˆ vietato...", text: "...lanciare dal finestrino mozziconi di sigaretta accesi", isTrue: true, topic: "Divieti" },
                    { root: "Il conducente puÃ²...", text: "...lanciare oggetti dal finestrino sulla banchina", isTrue: false, topic: "Divieti" },
                    { root: "Entrando in un centro abitato...", text: "...bisogna tenere conto che puÃ² cambiare spesso la precedenza", isTrue: true, topic: "Convivenza" },
                    { root: "Un incidente...", text: "...anche a bassa velocitÃ , puÃ² creare gravi problemi fisici", isTrue: true, topic: "Convivenza" }
                ]
            },
            {
                id: "L3", title: "Veicoli",
                items: [
                    { root: "I ciclomotori...", text: "...possono avere due o tre ruote", isTrue: true, topic: "Ciclomotori" },
                    { root: "I ciclomotori...", text: "...possono circolare alla velocitÃ  di 60 km/h", isTrue: false, topic: "Ciclomotori" },
                    { root: "I motocicli...", text: "...hanno cilindrata superiore a 50 cm3", isTrue: true, topic: "Motocicli" },
                    { root: "Le autovetture...", text: "...possono avere motore elettrico", isTrue: true, topic: "Autoveicoli" },
                    { root: "Le autovetture...", text: "...sono soggette a revisione ogni 5 anni", isTrue: false, topic: "Autoveicoli" }
                ]
            },
            {
                id: "L4", title: "Segnali di Pericolo",
                items: [
                    // Segnali con Immagini (Codici SVG mappati sotto)
                    { root: "Il segnale raffigurato preannuncia...", text: "...un tratto di strada deformata", isTrue: true, img: "001", topic: "Strada Deformata" },
                    { root: "Il segnale raffigurato preannuncia...", text: "...piÃ¹ curve consecutive", isTrue: false, img: "001", topic: "Strada Deformata" },
                    { root: "Il segnale raffigurato preannuncia...", text: "...un dosso", isTrue: true, img: "002", topic: "Dosso" },
                    { root: "Il segnale raffigurato preannuncia...", text: "...una galleria", isTrue: false, img: "002", topic: "Dosso" },
                    { root: "Il segnale raffigurato preannuncia...", text: "...una cunetta", isTrue: true, img: "003", topic: "Cunetta" },
                    { root: "Il segnale raffigurato preannuncia...", text: "...una curva pericolosa a destra", isTrue: true, img: "004", topic: "Curva Dx" },
                    { root: "Il segnale raffigurato preannuncia...", text: "...una curva a sinistra", isTrue: false, img: "004", topic: "Curva Dx" },
                    { root: "Il segnale raffigurato preannuncia...", text: "...una curva pericolosa a sinistra", isTrue: true, img: "005", topic: "Curva Sx" },
                    { root: "Il segnale raffigurato preannuncia...", text: "...una doppia curva, la prima a destra", isTrue: true, img: "006", topic: "Doppia Curva" },
                    { root: "Il segnale raffigurato preannuncia...", text: "...una doppia curva, la prima a sinistra", isTrue: true, img: "007", topic: "Doppia Curva" }
                ]
            }
        ];

        // --- 2. MOTORE SVG (DISEGNA I SEGNALI) ---
        const SVG_FACTORY = {
            base: (content) => `<svg viewBox="0 0 100 100" class="sign-svg"><path d="M50 5 L95 90 L5 90 Z" fill="white" stroke="#cc0000" stroke-width="8" stroke-linejoin="round"/>${content}</svg>`,
            
            '001': '<path d="M25 70 Q35 50 50 70 Q65 50 75 70" fill="none" stroke="black" stroke-width="6" stroke-linecap="round" />', // Deformata
            '002': '<path d="M25 70 Q50 30 75 70" fill="none" stroke="black" stroke-width="8" stroke-linecap="round" />', // Dosso
            '003': '<path d="M25 50 Q50 90 75 50" fill="none" stroke="black" stroke-width="8" stroke-linecap="round" />', // Cunetta
            '004': '<path d="M45 75 V50 Q45 35 70 40 L65 30 L80 45 L65 60 L70 50 Q55 45 55 75" fill="black" />', // Curva Dx
            '005': '<path d="M55 75 V50 Q55 35 30 40 L35 30 L20 45 L35 60 L30 50 Q45 45 45 75" fill="black" />', // Curva Sx
            '006': '<path d="M35 75 V60 Q35 45 50 45 Q65 45 65 35 L55 35 L70 20 L85 35 L75 35 Q75 55 50 55 Q45 55 45 75" fill="black" />', // Doppia Dx
            '007': '<path d="M65 75 V60 Q65 45 50 45 Q35 45 35 35 L45 35 L30 20 L15 35 L25 35 Q25 55 50 55 Q55 55 55 75" fill="black" />' // Doppia Sx
        };

        // --- 3. LOGICA APPLICAZIONE ---
        const app = {
            queue: [],
            currentIdx: 0,
            streak: 0,
            isBusy: false,

            init: function() {
                this.renderMenu();
                this.goMix(); // Parte subito in Mix Mode
                
                // Event Listeners sicuri
                document.getElementById('btn-true').onclick = () => this.handleAnswer(true);
                document.getElementById('btn-false').onclick = () => this.handleAnswer(false);
                document.getElementById('btn-start-custom').onclick = () => this.startCustom();
            },

            // Prepara la coda di domande
            buildQueue: function(mode, lessonId = null) {
                this.queue = [];
                this.currentIdx = 0;
                this.streak = 0;
                this.updateStreak();

                if (mode === 'mix') {
                    DB.forEach(lesson => this.queue.push(...lesson.items));
                    this.queue.sort(() => Math.random() - 0.5); // Shuffle
                    document.getElementById('mode-badge').innerText = "MIX MODE";
                } else if (mode === 'custom') {
                    const checkboxes = document.querySelectorAll('.topic-check:checked');
                    checkboxes.forEach(cb => {
                        const lesson = DB.find(l => l.id === cb.value);
                        if(lesson) this.queue.push(...lesson.items);
                    });
                    document.getElementById('mode-badge').innerText = "STUDIO MODE";
                }

                if (this.queue.length === 0) {
                    alert("Seleziona almeno una lezione!");
                    return false;
                }
                
                this.renderCard();
                return true;
            },

            renderCard: function() {
                if (this.currentIdx >= this.queue.length) {
                    this.showEndScreen();
                    return;
                }

                const item = this.queue[this.currentIdx];
                const cardComp = document.getElementById('txt-comp');
                const cardRoot = document.getElementById('txt-root');
                const imgContainer = document.getElementById('sign-container');

                // Gestione Immagine
                if (item.img && SVG_FACTORY[item.img]) {
                    imgContainer.innerHTML = SVG_FACTORY.base(SVG_FACTORY[item.img]);
                    imgContainer.classList.remove('hidden');
                } else {
                    imgContainer.classList.add('hidden');
                }

                // Testi
                cardRoot.innerText = item.root;
                cardComp.innerText = item.text;
                document.getElementById('topic-label').innerText = item.topic;

                // Animazione entrata
                cardComp.classList.remove('anim-enter');
                void cardComp.offsetWidth; // Trigger reflow
                cardComp.classList.add('anim-enter');

                // Progress Bar
                const pct = (this.currentIdx / this.queue.length) * 100;
                document.getElementById('progress-fill').style.width = `${pct}%`;
            },

            handleAnswer: function(userChoice) {
                if (this.isBusy || this.currentIdx >= this.queue.length) return;
                this.isBusy = true;

                const item = this.queue[this.currentIdx];
                const isCorrect = userChoice === item.isTrue;
                
                const layer = document.getElementById('feedback-layer');
                const icon = document.getElementById('fb-icon');
                const text = document.getElementById('fb-text');
                const wrapper = document.getElementById('card-wrapper');

                layer.classList.remove('hidden', 'bg-green-600/90', 'bg-red-600/90');
                layer.classList.add('flex');

                if (isCorrect) {
                    this.streak++;
                    confetti({ particleCount: 30, spread: 60, origin: { y: 0.7 } });
                    layer.classList.add('bg-green-600/90');
                    icon.className = "ph-fill ph-check-circle";
                    text.innerText = "ESATTO";
                } else {
                    this.streak = 0;
                    wrapper.classList.add('anim-shake');
                    layer.classList.add('bg-red-600/90');
                    icon.className = "ph-fill ph-x-circle";
                    text.innerText = "ERRATO";
                    setTimeout(() => wrapper.classList.remove('anim-shake'), 400);
                }

                this.updateStreak();

                // Wait & Next
                setTimeout(() => {
                    layer.classList.add('hidden');
                    layer.classList.remove('flex');
                    this.currentIdx++;
                    this.renderCard();
                    this.isBusy = false;
                }, 800);
            },

            updateStreak: function() {
                document.getElementById('streak-counter').innerText = this.streak;
            },

            showEndScreen: function() {
                document.getElementById('txt-root').innerText = "Sessione Terminata";
                document.getElementById('txt-comp').innerText = "Ottimo Lavoro! ðŸŽ‰";
                document.getElementById('sign-container').classList.add('hidden');
                confetti({ particleCount: 150, spread: 100 });
            },

            // --- NAVIGAZIONE ---
            goMix: function() {
                document.getElementById('screen-menu').style.transform = "translateY(100%)";
                this.buildQueue('mix');
            },

            toggleMenu: function() {
                const menu = document.getElementById('screen-menu');
                const isOpen = menu.style.transform === "translateY(0%)";
                menu.style.transform = isOpen ? "translateY(100%)" : "translateY(0%)";
            },

            startCustom: function() {
                if(this.buildQueue('custom')) {
                    this.toggleMenu();
                }
            },

            renderMenu: function() {
                const list = document.getElementById('list-container');
                list.innerHTML = '';
                DB.forEach(l => {
                    list.innerHTML += `
                        <label class="flex items-center gap-4 p-4 rounded-xl bg-white/5 border border-white/10 active:bg-white/10 transition-colors">
                            <input type="checkbox" value="${l.id}" class="topic-check w-5 h-5 accent-purple-500 rounded" checked>
                            <span class="text-sm font-bold text-gray-200">${l.title}</span>
                        </label>
                    `;
                });
            }
        };

        // Avvio App
        window.onload = () => app.init();

    </script>
</body>
</html>
